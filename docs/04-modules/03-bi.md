# 笔模块 (bi)

## 模块概述

`bi/` 模块负责笔的计算和管理，笔是缠论分析的基础单位。

---

## 目录结构

```
bi/
├── __init__.py
├── bi.py           # 笔类
├── bi_list.py      # 笔列表
└── bi_config.py    # 笔配置
```

---

## 核心概念

### 什么是笔？

笔是连接顶分形和底分形的线段：
- **上升笔**: 从底分形到顶分形
- **下降笔**: 从顶分形到底分形

```
上升笔          下降笔
    ●              ●
   /                \
  /                  \
 ●                    ●
底→顶              顶→底
```

### 成笔条件

1. **跨越条件**: 顶底分形之间至少跨越一定数量的K线
   - 严格笔: >= 4 根合并K线
   - 非严格笔: >= 3 根合并K线 且 >= 3 根原始K线

2. **价格条件**: 顶底分形的高低点关系正确
   - 上升笔: 底分形低点 < 顶分形高点
   - 下降笔: 顶分形高点 > 底分形低点

3. **分形有效性**: 分形之间的K线满足特定条件

---

## Bi 类

### 主要属性

```python
class Bi:
    idx: int              # 笔序号
    dir: BI_DIR           # 方向 (UP/DOWN)
    begin_klc: KLine      # 起始合并K线
    end_klc: KLine        # 结束合并K线
    is_sure: bool         # 是否确定
    
    parent_seg: Seg       # 所属线段
    bsp: BSPoint          # 关联的买卖点
    
    pre: Bi               # 前一笔
    next: Bi              # 后一笔
```

### 主要方法

```python
# 方向判断
bi.is_up()              # 是否上升笔
bi.is_down()            # 是否下降笔

# 价格获取
bi.get_begin_val()      # 起点价格
bi.get_end_val()        # 终点价格

# K线获取
bi.get_begin_klu()      # 起点K线
bi.get_end_klu()        # 终点K线

# 属性计算
bi.amp()                # 振幅
bi.get_klu_cnt()        # 包含的K线数量
bi.get_klc_cnt()        # 包含的合并K线数量

# MACD指标
bi.cal_macd_metric(algo, is_reverse)  # 计算MACD相关指标
```

---

## BiList 类

### 主要属性

```python
class BiList:
    bi_list: List[Bi]     # 笔列表
    last_end: KLine       # 最后一笔的尾部
    config: BiConfig      # 配置
```

### 主要方法

```python
# 更新笔
bi_list.update_bi(klc, last_klc, cal_virtual)

# 访问笔
bi_list[0]              # 第一笔
bi_list[-1]             # 最后一笔
len(bi_list)            # 笔的数量

# 遍历
for bi in bi_list:
    print(bi)
```

---

## BiConfig 配置

### 配置参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `bi_algo` | "normal" | 笔算法: normal/fx |
| `is_strict` | True | 是否严格笔 |
| `bi_fx_check` | "strict" | 分形检查方法 |
| `gap_as_kl` | False | 缺口是否算作K线 |
| `bi_end_is_peak` | True | 笔端点必须是极值 |
| `bi_allow_sub_peak` | True | 允许次高低点成笔 |

### 笔算法 (bi_algo)

- **normal**: 标准笔算法，需要满足成笔条件
- **fx**: 顶底分形即成笔，无需其他条件

### 分形检查方法 (bi_fx_check)

- **strict** (默认): 底分形最低点必须比顶分形三元素最低点还低
- **loss**: 底分形最低点比顶分形中间元素低点还低
- **half**: 部分检查
- **totally**: 完全不重叠

```python
config = ChanConfig({
    "bi_strict": True,
    "bi_algo": "normal",
    "bi_fx_check": "strict",
})
```

---

## 使用示例

### 获取笔信息

```python
chan = Chan(...)

for bi in chan[0].bi_list:
    direction = "↑" if bi.is_up() else "↓"
    print(f"笔{bi.idx} {direction}: {bi.get_begin_val():.2f} → {bi.get_end_val():.2f}")
    print(f"  振幅: {bi.amp():.2f}")
    print(f"  K线数: {bi.get_klu_cnt()}")
    print(f"  确定: {'是' if bi.is_sure else '否'}")
```

### 统计笔信息

```python
# 统计上升笔和下降笔
up_count = sum(1 for bi in chan[0].bi_list if bi.is_up())
down_count = len(chan[0].bi_list) - up_count

print(f"上升笔: {up_count}, 下降笔: {down_count}")

# 计算平均振幅
avg_amp = sum(bi.amp() for bi in chan[0].bi_list) / len(chan[0].bi_list)
print(f"平均振幅: {avg_amp:.2f}")
```

### 查找特定笔

```python
# 查找振幅最大的笔
max_bi = max(chan[0].bi_list, key=lambda bi: bi.amp())
print(f"最大振幅笔: {max_bi.idx}, 振幅={max_bi.amp():.2f}")

# 查找最后一个上升笔
for bi in reversed(chan[0].bi_list):
    if bi.is_up():
        print(f"最后上升笔: {bi.idx}")
        break
```

---

## MACD指标计算

笔提供多种MACD相关指标计算：

```python
from common.enums import MACD_ALGO

bi = chan[0].bi_list[-1]

# 不同的MACD算法
peak = bi.cal_macd_metric(MACD_ALGO.PEAK, False)      # 柱子峰值
area = bi.cal_macd_metric(MACD_ALGO.AREA, False)      # 面积
slope = bi.cal_macd_metric(MACD_ALGO.SLOPE, False)    # 斜率
amp = bi.cal_macd_metric(MACD_ALGO.AMP, False)        # 涨跌幅
```

| 算法 | 说明 |
|------|------|
| PEAK | MACD柱子最高值 |
| AREA | 同向MACD面积 |
| FULL_AREA | 完整MACD面积 |
| DIFF | MACD最大最小差值 |
| SLOPE | 笔的斜率 |
| AMP | 笔的涨跌幅 |
| VOLUME | 成交量总和 |
| AMOUNT | 成交额总和 |

---

## 虚笔处理

最后一笔可能是"虚笔"（未确定的笔）：

```python
last_bi = chan[0].bi_list[-1]

if not last_bi.is_sure:
    print("最后一笔是虚笔，可能会改变")
    print(f"  sure_end列表: {last_bi.sure_end}")
```

虚笔会随着新K线的加入而更新或确定。

---

## 下一步

- [线段模块](./04-seg.md) - 了解线段计算
- [自定义笔算法](../06-development/02-custom-bi-algo.md) - 开发自定义笔

